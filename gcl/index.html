<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Gradient Control Laboratories</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #fff;
        }

        #container {
            width: 100%;
            height: 100%;
        }

        /* Person link hover: color shift instead of underline */
        .person-link {
            text-decoration: none;
        }

        .person-link text {
            transition: fill 0.2s ease;
        }

        .person-link:hover text {
            fill: #0057b8 !important;
        }

        .person-link:hover .person-bg {
            fill: #eef4ff !important;
        }
    </style>
</head>

<body>
    <div id="container"></div>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script>
        (function () {
            //
            // Category definitions and colors
            //
            const categories = {
                "Software": { color: "#c5d5ea", border: "#9bb5d4" },
                "Hardware": { color: "#c9e8c9", border: "#9bca9b" },
                "CAD": { color: "#f5e8c0", border: "#d8c898" },
                "Academia": { color: "#f2c8d4", border: "#d4a0b0" },
                "Collective": { color: "#d8c8e8", border: "#b8a0d0" }
            };

            const originColor = "#c8c0e0";
            const originBorder = "#a098c0";

            //
            // People URLs from NSF Tech Labs RFI Response
            //
            const personUrls = {
                "Blake Courter": "https://www.blakecourter.com/",
                "Luke Church, PhD": "https://www.linkedin.com/in/lukechurch/",
                "Dan Rubel": "https://www.linkedin.com/in/danrubel/",
                "Steve DeMai": "https://www.linkedin.com/in/stephen-demai-a5ba2b4/",
                "Keegan McNamara": "https://www.linkedin.com/in/keeganmcnamara/",
                "Mariana Marasoiu, PhD": "https://www.linkedin.com/in/marianamarasoiu/"
            };

            //
            // Node data — positions scaled to 0.6x to fit embedded viewports
            //
            const nodes = [
                // Origin
                { id: "Gradient Control Laboratories", type: "origin", ix: 0, iy: 0 },

                // People
                { id: "Blake Courter", type: "person", ix: -132, iy: -156 },
                { id: "Luke Church, PhD", type: "person", ix: 96, iy: -156 },
                { id: "Dan Rubel", type: "person", ix: 120, iy: -48 },
                { id: "Steve DeMai", type: "person", ix: -150, iy: 48 },
                { id: "Keegan McNamara", type: "person", ix: -132, iy: 150 },
                { id: "Robert Iannuzzo", type: "person", ix: 18, iy: 150 },
                { id: "Emma Brennan", type: "person", ix: 180, iy: 72 },
                { id: "Mariana Marasoiu, PhD", type: "person", ix: 258, iy: 156 },

                // Organizations
                { id: "PTC", type: "org", category: "Software", ix: -276, iy: -222 },
                { id: "SpaceClaim", type: "org", category: "Software", ix: -162, iy: -228 },
                { id: "nTop", type: "org", category: "Software", ix: -60, iy: -228 },
                { id: "Autodesk", type: "org", category: "Software", ix: 72, iy: -228 },
                { id: "Thales", type: "org", category: "Software", ix: 168, iy: -228 },
                { id: "Vibe", type: "org", category: "Software", ix: 252, iy: -228 },
                { id: "GrabCAD", type: "org", category: "Software", ix: -168, iy: -66 },
                { id: "Stratasys", type: "org", category: "Hardware", ix: -174, iy: -30 },
                { id: "SolidWorks", type: "org", category: "Software", ix: -264, iy: 12 },
                { id: "Avid", type: "org", category: "Hardware", ix: -288, iy: 84 },
                { id: "Google (Dart)", type: "org", category: "CAD", ix: 96, iy: -102 },
                { id: "Eclipse", type: "org", category: "CAD", ix: 162, iy: -6 },
                { id: "Lark Systems", type: "org", category: "Collective", ix: 252, iy: -90 },
                { id: "Cambridge University", type: "org", category: "Academia", ix: 336, iy: -186 },
                { id: "PPIG", type: "org", category: "Academia", ix: 348, iy: 48 },
                { id: "Google", type: "org", category: "CAD", ix: 348, iy: 120 },
                { id: "AWS", type: "org", category: "Hardware", ix: -258, iy: 186 },
                { id: "VC", type: "org", category: "Collective", ix: -168, iy: 198 },
                { id: "Arkham", type: "org", category: "Collective", ix: -72, iy: 198 },
                { id: "Mythic", type: "org", category: "CAD", ix: 36, iy: 198 },
                { id: "Comcast", type: "org", category: "Hardware", ix: 186, iy: 126 }
            ];

            // Initialize simulation positions from compact coordinates
            nodes.forEach(n => { n.x = n.ix; n.y = n.iy; });

            //
            // Link data
            //
            const people = [
                "Blake Courter", "Luke Church, PhD", "Dan Rubel", "Steve DeMai",
                "Keegan McNamara", "Robert Iannuzzo", "Emma Brennan", "Mariana Marasoiu, PhD"
            ];

            const links = [
                // All people connect to GCL
                ...people.map(p => ({
                    source: p,
                    target: "Gradient Control Laboratories",
                    linkType: "person-origin"
                })),

                // Blake Courter
                { source: "Blake Courter", target: "PTC" },
                { source: "Blake Courter", target: "SpaceClaim" },
                { source: "Blake Courter", target: "nTop" },
                { source: "Blake Courter", target: "GrabCAD" },
                { source: "Blake Courter", target: "Stratasys" },

                // Luke Church, PhD
                { source: "Luke Church, PhD", target: "Autodesk" },
                { source: "Luke Church, PhD", target: "Thales" },
                { source: "Luke Church, PhD", target: "Vibe" },
                { source: "Luke Church, PhD", target: "Google (Dart)" },
                { source: "Luke Church, PhD", target: "Lark Systems" },
                { source: "Luke Church, PhD", target: "Cambridge University" },

                // Dan Rubel
                { source: "Dan Rubel", target: "Eclipse" },
                { source: "Dan Rubel", target: "Lark Systems" },
                { source: "Dan Rubel", target: "Google (Dart)" },

                // Steve DeMai
                { source: "Steve DeMai", target: "SolidWorks" },
                { source: "Steve DeMai", target: "Avid" },
                { source: "Steve DeMai", target: "GrabCAD" },
                { source: "Steve DeMai", target: "Stratasys" },

                // Keegan McNamara
                { source: "Keegan McNamara", target: "AWS" },
                { source: "Keegan McNamara", target: "VC" },
                { source: "Keegan McNamara", target: "Arkham" },
                { source: "Keegan McNamara", target: "Mythic" },

                // Emma Brennan
                { source: "Emma Brennan", target: "Lark Systems" },
                { source: "Emma Brennan", target: "Comcast" },

                // Mariana Marasoiu, PhD
                { source: "Mariana Marasoiu, PhD", target: "Cambridge University" },
                { source: "Mariana Marasoiu, PhD", target: "PPIG" },
                { source: "Mariana Marasoiu, PhD", target: "Google" },
                { source: "Mariana Marasoiu, PhD", target: "Lark Systems" },

                // Acquisition: Stratasys acquired GrabCAD
                { source: "Stratasys", target: "GrabCAD", linkType: "acquisition" }
            ];

            //
            // Layout constants — scaled ~1.25x from original
            //
            const orgFontSize = 18;
            const personFontSize = 22;
            const originFontSize = 35;
            const padX = 18;
            const padY = 10;
            const lineHeight = 22;

            function getLines(d) {
                if (d.type === "origin") return ["Gradient", "Control", "Laboratories"];
                if (d.type === "person") return [d.id];
                return d.id.split(" ");
            }

            function getNodeWidth(d) {
                if (d.type === "origin") return 275;
                const lines = getLines(d);
                const fs = d.type === "person" ? personFontSize : orgFontSize;
                const cw = fs * 0.58;
                const maxLen = Math.max(...lines.map(l => l.length));
                if (d.type === "person") return maxLen * cw + 16;
                return maxLen * cw + padX * 2;
            }

            function getNodeHeight(d) {
                if (d.type === "origin") return 188;
                if (d.type === "person") return personFontSize + 10;
                const lines = getLines(d);
                return lines.length * lineHeight + padY * 2;
            }

            function getCollisionRadius(d) {
                if (d.type === "origin") return 150;
                const w = getNodeWidth(d) / 2;
                const h = getNodeHeight(d) / 2;
                return Math.sqrt(w * w + h * h) + 6;
            }

            //
            // SVG setup
            //
            const container = document.getElementById("container");
            let width = container.clientWidth;
            let height = container.clientHeight;

            const svg = d3.select("#container")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [-width / 2, -height / 2, width, height]);

            //
            // Custom boundary repulsion force — uses container div dimensions
            //
            function forceBoundary() {
                let nodes;
                let boundW = width, boundH = height;
                const padding = 10;
                const strength = 1.2;

                function force(alpha) {
                    // Use floor alpha so boundary always has effect, even as sim cools
                    const s = Math.max(alpha, 0.1) * strength;
                    for (const d of nodes) {
                        const r = getCollisionRadius(d);
                        const left = -boundW / 2 + padding + r;
                        const right = boundW / 2 - padding - r;
                        const top = -boundH / 2 + padding + r;
                        const bottom = boundH / 2 - padding - r;

                        if (d.x < left) d.vx += (left - d.x) * s;
                        if (d.x > right) d.vx += (right - d.x) * s;
                        if (d.y < top) d.vy += (top - d.y) * s;
                        if (d.y > bottom) d.vy += (bottom - d.y) * s;
                    }
                }

                force.initialize = function (_) { nodes = _; };
                force.resize = function (w, h) { boundW = w; boundH = h; return force; };
                return force;
            }

            const boundary = forceBoundary();

            //
            // Force simulation
            //
            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links)
                    .id(d => d.id)
                    .strength(d => d.linkType === "acquisition" ? 0.8 : 0.04)
                    .distance(d => {
                        if (d.linkType === "acquisition") return 5;
                        if (d.linkType === "person-origin") return 180;
                        return 130;
                    }))
                .force("charge", d3.forceManyBody().strength(-150))
                .force("collide", d3.forceCollide(d => getCollisionRadius(d)).strength(0.9))
                .force("x", d3.forceX(d => d.ix).strength(0.15))
                .force("y", d3.forceY(d => d.iy).strength(0.15))
                .force("boundary", boundary);

            //
            // Render links
            //
            const link = svg.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("stroke", "#b8b8b8")
                .attr("stroke-width", d => {
                    if (d.linkType === "acquisition") return 0;
                    return d.linkType === "person-origin" ? 2.5 : 1.5;
                })
                .attr("stroke-opacity", 0.5);

            //
            // Render nodes
            //
            const node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .style("cursor", "grab")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            // --- Origin node: large ellipse ---
            const originNode = node.filter(d => d.type === "origin");

            originNode.append("ellipse")
                .attr("rx", 144)
                .attr("ry", 100)
                .attr("fill", originColor)
                .attr("stroke", originBorder)
                .attr("stroke-width", 2.5)
                .attr("opacity", 0.75);

            const originText = originNode.append("text")
                .attr("text-anchor", "middle")
                .attr("font-size", `${originFontSize}px`)
                .attr("font-weight", "bold")
                .attr("fill", "#333");

            originText.selectAll("tspan")
                .data(d => getLines(d))
                .join("tspan")
                .attr("x", 0)
                .attr("y", (d, i, nodes) => `${(i - (nodes.length - 1) / 2) * 1.25}em`)
                .text(d => d);

            // --- Organization nodes: rounded rectangles ---
            const orgNodes = node.filter(d => d.type === "org");

            orgNodes.append("rect")
                .attr("x", d => -getNodeWidth(d) / 2)
                .attr("y", d => -getNodeHeight(d) / 2)
                .attr("width", d => getNodeWidth(d))
                .attr("height", d => getNodeHeight(d))
                .attr("rx", 7)
                .attr("ry", 7)
                .attr("fill", d => categories[d.category].color)
                .attr("stroke", d => categories[d.category].border)
                .attr("stroke-width", 1.5);

            const orgText = orgNodes.append("text")
                .attr("text-anchor", "middle")
                .attr("dominant-baseline", "central")
                .attr("font-size", `${orgFontSize}px`)
                .attr("fill", "#333");

            orgText.selectAll("tspan")
                .data(d => getLines(d))
                .join("tspan")
                .attr("x", 0)
                .attr("y", (d, i, nodes) => `${(i - (nodes.length - 1) / 2) * 1.2}em`)
                .text(d => d);

            // --- Person nodes: bold text with white background and optional link ---
            const personNodes = node.filter(d => d.type === "person");

            // Wrap persons that have URLs in an <a> element
            personNodes.each(function (d) {
                const g = d3.select(this);
                const url = personUrls[d.id];
                const wrapper = url
                    ? g.append("a")
                        .attr("href", url)
                        .attr("target", "_blank")
                        .attr("class", "person-link")
                    : g;

                // White background rect
                const w = getNodeWidth(d);
                const h = getNodeHeight(d);
                wrapper.append("rect")
                    .attr("class", "person-bg")
                    .attr("x", -w / 2)
                    .attr("y", -h / 2)
                    .attr("width", w)
                    .attr("height", h)
                    .attr("rx", 4)
                    .attr("ry", 4)
                    .attr("fill", "white")
                    .attr("opacity", 0.9);

                // Text label
                wrapper.append("text")
                    .attr("text-anchor", "middle")
                    .attr("dominant-baseline", "central")
                    .attr("font-size", `${personFontSize}px`)
                    .attr("font-weight", "bold")
                    .attr("fill", "#222")
                    .style("pointer-events", "none")
                    .text(d.id);
            });

            //
            // Legend — bottom right corner
            //
            const legendPadding = 12;
            const legendItemH = 28;
            const legendSwatchW = 22;
            const legendSwatchH = 17;
            const legendEntries = Object.entries(categories);
            const legendH = legendEntries.length * legendItemH + legendPadding * 2;
            const legendW = 120;
            const legendTotalW = legendW + legendPadding * 2;
            const legendTotalH = legendH;

            const legend = svg.append("g");

            function updateLegendPosition() {
                legend.attr("transform",
                    `translate(${width / 2 - legendTotalW - 15}, ${height / 2 - legendTotalH - 15})`);
            }
            updateLegendPosition();

            legend.append("rect")
                .attr("x", -legendPadding)
                .attr("y", -legendPadding)
                .attr("width", legendTotalW)
                .attr("height", legendTotalH)
                .attr("rx", 8)
                .attr("ry", 8)
                .attr("fill", "white")
                .attr("stroke", "#ccc")
                .attr("stroke-width", 1);

            const legendItem = legend.selectAll(".legend-item")
                .data(legendEntries)
                .join("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(0, ${i * legendItemH})`);

            legendItem.append("rect")
                .attr("width", legendSwatchW)
                .attr("height", legendSwatchH)
                .attr("rx", 4)
                .attr("ry", 4)
                .attr("fill", d => d[1].color)
                .attr("stroke", d => d[1].border)
                .attr("stroke-width", 1);

            legendItem.append("text")
                .attr("x", legendSwatchW + 8)
                .attr("y", legendSwatchH / 2)
                .attr("dominant-baseline", "central")
                .attr("font-size", "14px")
                .attr("fill", "#444")
                .text(d => d[0]);

            //
            // Simulation tick — includes hard boundary clamping as safety net
            //
            simulation.on("tick", () => {
                // Hard clamp to container bounds
                const pad = 10;
                nodes.forEach(d => {
                    const r = getCollisionRadius(d);
                    d.x = Math.max(-width / 2 + pad + r, Math.min(width / 2 - pad - r, d.x));
                    d.y = Math.max(-height / 2 + pad + r, Math.min(height / 2 - pad - r, d.y));
                });

                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });

            //
            // Drag behavior
            //
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
                d3.select(this).style("cursor", "grabbing");
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
                d3.select(this).style("cursor", "grab");
            }

            //
            // Responsive resize — updates boundary force with new container dimensions
            //
            function resize() {
                width = container.clientWidth;
                height = container.clientHeight;
                svg
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [-width / 2, -height / 2, width, height]);

                boundary.resize(width, height);
                updateLegendPosition();
                simulation.alpha(0.3).restart();
            }

            window.addEventListener("resize", resize);
        })();
    </script>
</body>

</html>
